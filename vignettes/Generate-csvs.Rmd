---
title: "Generate SIS Connect files for multiple plant species"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate-csvs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The aim of `LCr` is to speed up the process of adding Least Concern (LC) species to the [IUCN Red List](https://www.iucnredlist.org/). We'll start with a list of plant species and end up with a zip file of CSV files that contain the minimal required information to support a Least Concern assessment. The zip file can then be uploaded into [SIS Connect](https://connect.iucnredlist.org/) (requires registration) and then to SIS where the draft assessments can be edited, reviewed and hopefully published on the IUCN Red List. Spatial data to support the assessment is also generated by `LCr`.

Before you start, make sure you have the `rWCVP` package installed along with the associated data package `rWCVPdata`. For more information see the [Getting Started](https://matildabrown.github.io/rWCVP/articles/rWCVP.html) guide.

Load the `LCr` library:

```{r setup}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(LCr)
library(dplyr)
library(rWCVP)
library(rWCVPdata)
```

### Get name keys from a species list

The first step is to determine the list of species you want to assess. A [study](https://nph.onlinelibrary.wiley.com/doi/full/10.1111/nph.19592) recently predicted extinction risk for all species of flowering plants (Angiosperms). You can filter on species that are confidently predicted to be LC, but note that predictions can be wrong so please verify these are genuine LC species. You can either filter species from the predictions table or generate a data frame from a list as below.

```{r}
lc_species <-
  data.frame(sp = c(
    "Crabbea acaulis", "Crabbea cirsioides", "Crabbea nana", "Crabbea velutina"
  ))
print(lc_species)
```
Next we can reconcile the names against other data sources using existing packages such as `rWCVP` and `rgbif`. This will provide us with name keys that can be used to search for data on those species.

In this case we want to enforce a single matching name for every name in our list so we set the `match` parameter to 'single', but you can set this to 'multiple' if you wish to allow multiple matches. 
Similarly, we want to focus only on accepted species, so we set the `tax_status` parameter to 'accepted', but you can set this to 'any' if you wish to return a different taxonomic status.

```{r}
lc_keys <-
  get_name_keys(
    df = lc_species,
    name_column = "sp",
    tax_status = "accepted",
    match = "single"
  )

# take a look at the resulting table
glimpse(lc_keys)
```

The name matching went well and we now have some useful fields to help us find more data for these species. The `GBIF_usageKey` is an identifier for species according to the GBIF name backbone and the `wcvp_ipni_id` identifies the species according to the WCVP name backbone. 

### Generate an LC point file

Use the `make_LC_points` function to kick off a download from GBIF, clean the downloaded occurences, and reformat them to IUCN spatial standards. Name information is required for the standard point file. Set the `range_check` parameter to `TRUE` if you want to exclude points outside the native range according to `WCVP`, otherwise standard cleaning protocols are applied using the `CoordinateCleaner` package.

Note that we will use the `rGBIF` package to obtain the occurrence data. You will need to set up your GBIF credentials to obtain the downloads. After you have set up an account at [GBIF](https://www.gbif.org/) you need to register your credential in the r environment - see this [post](https://docs.ropensci.org/rgbif/articles/gbif_credentials.html) for an explanation.

The IUCN spatial point standards require some fields relating to the data compiler and associated institution. These can be manually entered as below.

```{r message=TRUE, warning=FALSE}
lc_sis_occs <-
  make_LC_points(
    keys_df = lc_keys,
    first_name = "Steven",
    second_name = "Bachman",
    institution = "Royal Botanic Gardens, Kew",
    range_check = TRUE
  )
```
We can see that some occurrence records were removed as they did not pass the cleaning tests or were outside the native range. Note that the output from `make_LC_points` will likely be a large list with two or three objects: a data frame of occurrences called `points`, a data frame called `citation` that holds the citation details for this download, and if you included the `range_check` it will also return the native ranges as a data frame. The GBIF citation is important to retain as we need to cite the use of this data in the Red List assessment and we'll add this to the reference file later on.

### Generate LC CSV files

We can now generate the LC CSV files. We can use the `wcvp_ipni_id` field as a unique identifier. We need to add the assessor details again as this is registered in the credits csv file, not that the email address is required. Now we can add our GBIF citation back in so that it goes in the references csv file. Finally, the native ranges we generated earlier can be used to help define the list of countries that our species are native to. 

```{r}
lc_sis_files <- make_sis_csvs(unique_id = lc_keys$wcvp_ipni_id,
                              wcvp_ipni_id = lc_keys$wcvp_ipni_id,
                              first_name = "Steven",
                              second_name = "Bachman",
                              email = "s.bachman@kew.org",
                              institution = "Royal Botanic Gardens, Kew",
                              gbif_ref = lc_sis_occs$citation,
                              native_ranges = lc_sis_occs$native_ranges
                              )
```

The final step is to make a ZIP file as this is needed to import the data into [SIS Connect](https://connect.iucnredlist.org/). With the `lc_sis_files` list object we just created we run the `make_zip` function that saves the zip file to your current working directory.

All done! Send those LC species to the Red list and start working on the next batch.

```{r}
make_zip(lc_sis_files)
```

